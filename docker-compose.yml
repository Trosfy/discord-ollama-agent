# ============================================================================
# DEPRECATED: This file has been split into two files for better architecture
# ============================================================================
#
# NEW ARCHITECTURE (as of 2025-12-26):
# - docker-compose.infra.yml - Infrastructure services (always-on)
# - docker-compose.app.yml    - Application services (toggleable)
#
# WHY: This split allows the admin dashboard to safely start/stop application
# services without stopping itself or core infrastructure.
#
# USAGE:
#   Start everything:  ./start.sh
#   Stop apps only:    ./stop.sh
#   Manual start:      docker compose -f docker-compose.infra.yml -f docker-compose.app.yml up -d
#
# See DOCKER_ARCHITECTURE.md for full documentation.
#
# This file is kept for backward compatibility but SHOULD NOT BE USED.
# It may be removed in a future version.
# ============================================================================

services:
  logging-service:
    build: ./logging-service
    container_name: trollama-logging
    volumes:
      - ./logs:/app/logs
      - ./shared:/shared
    ports:
      - "9999:9999"
      - "9998:9998"  # Health check port
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9998/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: trollama-dynamodb
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -inMemory"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/8000' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  auth-service:
    build: ./auth-service
    container_name: trollama-auth
    ports:
      - "8002:8002"  # Auth service port
    command: >
      sh -c "python setup_admin.py && uvicorn app.main:app --host 0.0.0.0 --port 8002"
    environment:
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - DYNAMODB_REGION=us-east-1
      - DYNAMODB_ACCESS_KEY=test
      - DYNAMODB_SECRET_KEY=test
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-change-me-in-production}
      - LOGGING_HOST=logging-service
      - LOGGING_PORT=9999
      - PYTHONPATH=/shared
    volumes:
      - ./auth-service:/app
      - ./shared:/shared
    depends_on:
      dynamodb-local:
        condition: service_healthy
      logging-service:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  admin-service:
    build: ./admin-service
    container_name: trollama-admin
    ports:
      - "8003:8000"  # Admin service port
    command: >
      sh -c "python /shared/init_dynamodb.py && uvicorn app.main:app --host 0.0.0.0 --port 8000"
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Allow access to host services (Ollama)
    group_add:
      - "988"  # Add host docker group GID for socket access
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [utility]  # Only need utility for nvidia-smi
    env_file:
      - .env
    environment:
      - DYNAMODB_ENDPOINT=http://trollama-dynamodb:8000
      - DYNAMODB_REGION=us-east-1
      - DYNAMODB_ACCESS_KEY=test
      - DYNAMODB_SECRET_KEY=test
      - FASTAPI_URL=http://trollama-fastapi:8000
      - AUTH_SERVICE_URL=http://trollama-auth:8002
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-change-me-in-production}
      - DISCORD_ADMIN_WEBHOOK_URL=${DISCORD_ADMIN_WEBHOOK_URL}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - LOGGING_HOST=trollama-logging
      - LOGGING_PORT=9999
      - PYTHONPATH=/shared
    volumes:
      - ./admin-service:/app  # Mount codebase for hot reload
      - ./shared:/shared
      - ./logs:/app/logs  # Log directory for cleanup service
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Host /proc for PSI metrics (read-only)
      - /proc/pressure:/host/proc/pressure:ro
    depends_on:
      dynamodb-local:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      fastapi-service:
        condition: service_healthy
      logging-service:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  sglang-server:
    profiles: ["performance"]  # Only start with performance profile
    image: lmsysorg/sglang:spark  # GB10-compatible image
    container_name: trollama-sglang
    ports:
      - "30000:30000"
    volumes:
      - ~/.cache/huggingface:/root/.cache/huggingface:ro  # Model cache
      - ~/.cache/tiktoken_encodings:/tiktoken_encodings:ro  # Tiktoken encodings for gpt-oss
    shm_size: 32gb
    ipc: host
    runtime: nvidia       # NVIDIA GPU access

    environment:
      - CUDA_VISIBLE_DEVICES=0
      - TIKTOKEN_ENCODINGS_BASE=/tiktoken_encodings
    command: >
      python3 -m sglang.launch_server
      --model-path openai/gpt-oss-120b
      --speculative-algorithm EAGLE3
      --speculative-draft-model-path lmsys/EAGLE3-gpt-oss-120b-bf16
      --speculative-num-steps 3
      --speculative-eagle-topk 1
      --speculative-num-draft-tokens 4
      --tp 1
      --context-length 40960
      --max-total-tokens 40960
      --host 0.0.0.0
      --port 30000
      --reasoning-parser gpt-oss
      --tool-call-parser gpt-oss
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--output-document=/dev/null", "http://localhost:30000/v1/models"]
      interval: 5s
      timeout: 10s
      retries: 84  # Allow up to ~7 min for model to load
      start_period: 300s  # MoE weight shuffling: ~8 min (unavoidable)
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  fastapi-service:
    build: ./fastapi-service
    container_name: trollama-fastapi
    ports:
      - "8001:8000"
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Enable host.docker.internal on Linux
    env_file:
      - .env
    environment:
      - DYNAMODB_ENDPOINT=http://trollama-dynamodb:8000
      - LOGGING_HOST=trollama-logging
      - LOGGING_PORT=9999
      - PYTHONPATH=/shared
      - SGLANG_ENDPOINT=http://trollama-sglang:30000
    volumes:
      - ./fastapi-service:/app
      - ./shared:/shared
      - temp-files:/tmp/discord-bot-artifacts
      - temp-files:/tmp/discord-bot-uploads
    depends_on:
      dynamodb-local:
        condition: service_healthy
      logging-service:
        condition: service_healthy
      # sglang-server dependency is optional - only required for performance profile
      # If using performance profile, start with: docker-compose --profile performance up -d
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  discord-bot:
    build: ./discord-bot
    container_name: trollama-discord-bot
    env_file:
      - .env
    environment:
      - FASTAPI_WS_URL=ws://trollama-fastapi:8000/ws/discord
      - ADMIN_SERVICE_URL=http://trollama-admin:8000
      - LOGGING_HOST=trollama-logging
      - LOGGING_PORT=9999
      - PYTHONPATH=/shared
    ports:
      - "9997:9998"  # Health check port (external:internal)
    volumes:
      - ./discord-bot:/app
      - ./shared:/shared
      - temp-files:/tmp/discord-bot-artifacts
      - temp-files:/tmp/discord-bot-uploads
    depends_on:
      fastapi-service:
        condition: service_healthy
      logging-service:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Health endpoint checks WebSocket connection status

  web-service:
    build: ./web-service
    container_name: trollama-web
    ports:
      - "8502:3000"  # Next.js web interface (host:container)
    environment:
      - NEXT_PUBLIC_API_URL=http://fastapi-service:8000
      - NEXT_PUBLIC_WS_URL=ws://fastapi-service:8000
      - NODE_ENV=production
    volumes:
      - ./web-service:/app
      - /app/node_modules
      - /app/.next
      - /var/run/docker.sock:/var/run/docker.sock  # Docker socket for container management
      - ./web-service/scripts:/app/scripts  # Host management scripts
    depends_on:
      fastapi-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  dynamodb_data:
    driver: local
  temp-files:
    driver: local

networks:
  default:
    name: trollama-network
